<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://camel.apache.org/schema/spring
       http://camel.apache.org/schema/spring/camel-spring.xsd">

    <bean id="testTwitterBeanProcessor" class="com.pentalog.twitter.processor.TwitterBeanProcessor"/>
    <bean id="httpProcessor" class="com.pentalog.twitter.processor.HTTPProcessor"/>
    <!-- camel activemq http://camel.apache.org/using-camelproxy.html component to connect to the broker   -->
    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="brokerURL" value="tcp://${cluster.local.ip}:${cluster.local.jms.port}"/>
    </bean>

    <camelContext id="camelContext" xmlns="http://camel.apache.org/schema/spring">
        <endpoint id="twitterStreamEndpoint"
                  uri="twitter://streaming/sample?delay=${twitter.stream.delay}&amp;type=${twitter.stream.type}&amp;consumerKey=${twitter.stream.consumerKey}&amp;consumerSecret=${twitter.stream.consumerSecret}&amp;accessToken=${twitter.stream.accessToken}&amp;accessTokenSecret=${twitter.stream.accessTokenSecret}"/>


        <route>
            <from uri="timer://runOnce?repeatCount=1&amp;delay=3000"/>
            <to uri="bean:nodeManager?method=buildNodes"/>
        </route>


        <!-- Master Routes -->

        <route id="masterTwitterStream" autoStartup="false">
            <from ref="twitterStreamEndpoint"/>
            <multicast>
                <to uri="seda:tweetsQueue?size=1000"/>
                <to uri="bean:nodeStats?method=incrementCount"/>
            </multicast>
        </route>


        <route id="masterIncoming" autoStartup="true">
            <from uri="activemq:queue:MASTER"/>
            <to uri="bean:masterController"/>
        </route>
        <!-- End Of Master -->

        <!--SLAVE -->


        <route id="slaveIncoming" autoStartup="true">
            <from uri="activemq:queue:SLAVE"/>
            <to uri="bean:slaveController"/>
        </route>

        <route id="slaveTOComponents">
            <from uri="seda:slaveTweetHandler"/>
            <multicast>
                <to uri="log:com.pentalog.twitter"/>
                <process ref="testTwitterBeanProcessor"/>
                <to uri="bean:nodeStats?method=incrementCount"/>
                <loadBalance>
                    <roundRobin/>
                    <to uri="tweetanalyzer:tweetanalyzer"/>
                    <to uri="tweetanalyzer:tweetanalyzer"/>
                    <to uri="tweetanalyzer:tweetanalyzer"/>
                </loadBalance>
            </multicast>
        </route>

        <route>
            <from uri="jetty:http://${local.ip}:${local.jetty.port}/stats"/>
            <to uri="bean:nodeStats?method=getCountProcessed"/>
        </route>

        <!-- END OF SLAVE DECLARATIONS -->


    </camelContext>

</beans>