<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://camel.apache.org/schema/spring
       http://camel.apache.org/schema/spring/camel-spring.xsd">

    <bean id="testTwitterBeanProcessor" class="com.pentalog.twitter.processor.TwitterBeanProcessor"/>
    <bean id="httpProcessor" class="com.pentalog.twitter.processor.HTTPProcessor"/>
    <!-- camel activemq http://camel.apache.org/using-camelproxy.html component to connect to the broker   -->
    <bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="brokerURL" value="tcp://${cluster.local.ip}:${cluster.local.jms.port}"/>
    </bean>

    <camelContext id="camelContext" xmlns="http://camel.apache.org/schema/spring">


       <route>
            <from uri="timer://runOnce?repeatCount=1&amp;delay=3000"/>
            <to uri="bean:nodeManager?method=buildNodes"/>
        </route>


        <!-- Master Routes -->

        <route id="masterTwitterStream" autoStartup="false">
            <from ref="twitterStreamEndpoint"/>
            <multicast>
                <to uri="seda:tweetsQueue?size=10000"/>
                <to uri="bean:nodeStats?method=incrementCount"/>
            </multicast>
        </route>



        <route id="masterWEBSocket">
            <from uri="seda:masterDisplayFilteredTweets?size=1000"/>
            <to uri="websocket:camel-tweet?sendToAll=true&amp;host=${local.ip}&amp;port=${local.websocket.port}"/>
        </route>

        <route>
            <from uri="jetty:http://${local.ip}:${local.jetty.port}/startFiltering/"/>
            <process ref="filterTweetsLauncher"/>
        </route>


        <!-- End Of Master -->

        <!--SLAVE -->

        <route id="slaveTOComponents">
            <from uri="seda:slaveTweetHandler"/>
            <multicast>
                <to uri="log:com.pentalog.twitter"/>
                <process ref="testTwitterBeanProcessor"/>
                <process ref="roTweetProcessor"/>
                <process ref="saveTweets"/>
                <process ref="tweetFilterPR"/>
                <to uri="tweetanalyzer:tweetWords"/>
            </multicast>
        </route>

        <route id="slaveROTweets">
            <from uri="seda:tweetsAboutRO"/>
            <to uri="mongodb:mongoConnectionBean?database=statistics&amp;collection=roTweets&amp;operation=insert"/>
        </route>


        <route id="saveTweets">
            <from uri="seda:saveTweets"/>
            <to uri="mongodb:mongoConnectionBean?database=statistics&amp;collection=allTweets&amp;operation=insert"/>
        </route>

        <route>
            <from uri="jetty:http://${local.ip}:${local.jetty.port}/stats"/>
            <to uri="bean:nodeStats?method=getCountProcessed"/>
        </route>

        <route>
            <from uri="jetty:http://${local.ip}:${local.jetty.port}/getGraph/{}/{}"/>
            <to uri="tweetanalyzer:getGraph"/>
        </route>

        <!-- END OF SLAVE DECLARATIONS -->


    </camelContext>

</beans>